<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.1.min.js"></script>
  <script src="ajax_functions.js"></script>

	<title>Dynamic map page</title>
	<style>
		body {
			font-family:Arial, Helvetica, sans-serif;
			font-size:14px;
		}
		ul{
			margin:0;
			padding:0;
		}

		h1 {
			height: 3vh;
		}
		label {
			font-weight:bold;
			width:100px;
			font-size:14px;
		}

		.box {
			border:#666666 solid 1px;
		}

    #info_list {
      height: 90vh;
			width: 10%;
			float: left;
			margin: 5px;
    }

		#map {
			height: 90vh;
			width: 70%;
			float: left;
			margin: 5px;
		}

		#details {
			height: 90vh;
			width: 18%;
			float: left;
			margin: 5px;
			position: relative;
    	overflow:hidden;

		}
		#request_details{
		display: none;

		}
		#driver_details{
		display: none;

		}
		.button {
			position: relative;
			left:0;
			margin: 0 auto;
			text-align: center;
    	overflow: hidden;
			padding: 10px;
			margin: 5px;
			text-decoration: none;

		}

		#cancel_request{
			background-color: rgb(214, 65, 65);
			color:white;

		}
		#redirect_request{
			background-color: rgb(97, 106, 152);
			color:white;
		}
		.no_decoration{
			text-decoration: none;
		}


	</style>
</head>

<body>
	<h1>Dynamic map</h1>

  <div id="info_list">
    <h3>List of requests</h3>
    <ul id="requests_list">
    </ul>
      <h3>List of drivers</h3>
      <ul id="drivers_list"></ul>

  </div>

	<div id="map">
	</div>
	<div id="detials">
		<div id="empty_details">
			<h3>Click on a marker to see options</h3>
		</div>

		<div id="request_details">
			<h3>Request details</h3>
			<ul>
				<li><span>Requets ID: </span> <span id="request_id"></span></li>
				<li><span>Time: </span> <span id="request_time"></span></li>
				<li><span>Notes: </span> <span id="request_notes"></span></li>
				<li><span>Price: </span> <span id="request_price"></span><span> SDG</span> </li>
				<li><span>Status: </span> <span id="request_status"></span></li>
				<li><span>Passenger name: </span> <span id="passenger_name"></span></li>
				<li><span>Passenger phone: </span> <span id="passenger_phone"></span></li>
			</ul>
			<a class="no_decoration" href="#cancel_request"><div class="button" id="cancel_request">Cancel Request</div></a>
			<a class="no_decoration" href="#redirect_request"><div class="button" id="redirect_request">Redirect Request</div></a>
		</div>

		<div id="driver_details">
				<h3>Driver details</h3>
				<ul>
				<li><span>Driver name: </span> <span id="driver_name"></span></li>
				<li><span>Driver phone: </span> <span id="driver_phone"></span></li>
					</ul>

					<!-- <div id="additionl_driver_info">
					<ul>
					<li><span>Vehicle: </span> <span id="driver_vehicle"></span></li>
					<li><span>Plate No.: </span> <span id="driver_plate"></span></li>
						</ul>

					</div> -->
					<span>Driver status: </span> <span id="driver_status"></span>

		</div>


		<script>
		window.globals = {};

			function initMap() {

				$( "#empty_details" ).css( "display", "block" );
				$( "#request_details" ).css( "display", "none" );
				$( "#driver_details" ).css( "display", "none" );
				var khartoumCords = {lat: 15.592791, lng: 32.534134};
				window.globals.map = new google.maps.Map(document.getElementById('map'), {
					zoom: 11,
					center: khartoumCords
				});

								CLEAR = "clear";
								REDIRECT = "redirect";
								REQUEST = "request";
								DRIVER = "driver";

				window.globals.selectedRequest = null;
				window.globals.selectionState = CLEAR;

				// selectionState = clear request  redirect  driver

				$( "#redirect_request" ).click(enterRedirectMode);

		}

    function  showMrakersAndDrivers(listOfRequests, listOfDrivers, timeNow){

				window.globals.requests = listOfRequests;
				window.globals.drivers = listOfDrivers;

				$("#requests_list").html('');
				$("#drivers_list").html('');

				for (var i = 0; i < window.globals.requests.length; i++) {
					id = window.globals.requests[i].request_id;
					time = timeNow - Number(window.globals.requests[i].time);
					var minus = "";
					if(time < 0) {
						minus = "-";
						time = -time;
					}
					var hours = Math.floor(time / 60 / 60);
					var minutes = Math.floor((time - 60 * 60 * hours) / 60);
					var seconds = (time - hours * 60 * 60 - minutes * 60 );
					// console.log(id +"  " + time);
					$("#requests_list").append('<li id="list_request'+id+'"><span>ID: </span> <span>' + id + '</span><span>,&emsp;</span><span>'+minus + hours+":" +minutes+":" + seconds+ '</span></li>');
					$("#list_request"+id).click(id, function (event){
						if (window.globals.selectionState != REDIRECT) {

							id = event.data;
							index = getRequestIndexById(id);
							animateMarker(window.globals.requestMarkers[index]);
							showRequestDetails(window.globals.requestMarkers[index].details);
							window.globals.selectedRequest = window.globals.requestMarkers[index].details;
						}
					});
				}

				for (var i = 0; i < window.globals.drivers.length; i++) {
					var name = window.globals.drivers[i].name;
					var id = window.globals.drivers[i].id;
					$("#drivers_list").append('<li id="list_driver'+id+'"><span>' + name + '</span></li>');
					$("#list_driver"+id).click(id, function (event){
						if (window.globals.selectionState != REDIRECT) {
							id = event.data;
							index = getDriverIndexById(id);
							// console.log(id +"    "+index);
							animateMarker(window.globals.driversMarkers[index]);
						}
					});
				}

				clearMap();
      for (var i = 0; i < listOfRequests.length; i++) {
      	request = listOfRequests[i];
				showRequestMarker(request, i);
      }

			for (var i = 0; i < listOfDrivers.length; i++) {
				driver = listOfDrivers[i];
				showDriverMarker(driver, i);
			}
      // console.log(listOfDrivers);
    }

		function hideRequestsMarkers(){
				if (window.globals.requestMarkers != null) {
					for (var i = 0; i < window.globals.requestMarkers.length; i++) {
						window.globals.requestMarkers[i].setMap(null);
					}
				}
		}

		function clearMap(){

			hideRequestsMarkers();

			if (window.globals.driversMarkers != null) {
				for (var i = 0; i < window.globals.driversMarkers.length; i++) {
					window.globals.driversMarkers[i].setMap(null);
				}
			}

				window.globals.requestMarkers = [];
				window.globals.driversMarkers = [];

		}

		function showRequestMarker(request, i){
			var marker = new google.maps.Marker({
				position: {lat:  Number(request.pickup_lat) , lng:  Number(request.pickup_lng)},
				data: request
			});


			if (window.globals.selectionState != REDIRECT) {
				marker.setMap(window.globals.map);
			} else {
				marker.setMap(null);
			}

			if (request.status == "accepted") {
				// marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
				marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
			} else if (request.status == "on_the_way") {
				marker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png');
			} else if (request.status == "arrived_at_pickup") {
				marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
			}
		window.globals.requestMarkers[i] = marker;
		window.globals.requestMarkers[i].details = request;
		google.maps.event.addListener(marker, 'click', (function(marker, i) {
			return function() {
				showRequestDetails(marker.data);
				 animateMarker(marker);
			}
		})(marker, i));
		}

		function animateMarker(marker){
		marker.setAnimation(google.maps.Animation.BOUNCE);
		setTimeout(function(){ marker.setAnimation(null); }, 750);

		}

		function showDriverMarker(driver, i){
			var marker = new google.maps.Marker({
				position: {lat:  Number(driver.lat) , lng:  Number(driver.lng)},
				map: window.globals.map,
				data: driver
			});

			if (driver.status == "accepted") {
				// marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
				marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
			} else if (driver.status == "on_the_way") {
				marker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png');
			} else if (driver.status == "arrived_at_pickup") {
				marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
			}
		window.globals.driversMarkers[i] = marker;
		window.globals.driversMarkers[i].details = driver;
		google.maps.event.addListener(marker, 'click', (function(marker, i) {
			return function() {
				showDriverDetails(marker.data);
			}
		})(marker, i));
		}


		function showRequestDetails(requestDetails){
			$( "#empty_details" ).css( "display", "none" );
			$( "#request_details" ).css( "display", "block" );
			$( "#driver_details" ).css( "display", "block" );

			// $("#request_id" ).html("requestDetails.request_id");
			$("#request_id").html(requestDetails.request_id);
			time = new Date(requestDetails.time);
			var format = 'YYYY/MM/DD HH:mm:ss ZZ';
      // time = moment(Date, format).tz(zone).format(format);
			$("#request_time").html(requestDetails.time);
			$("#request_notes").html(requestDetails.notes);
			$("#request_price").html(requestDetails.price);
			$("#request_status").html(requestDetails.status);
			$("#passenger_name").html(requestDetails.passenger_name);
			$("#passenger_phone").html(requestDetails.passenger_phone);

			$("#driver_name").html(requestDetails.driver_name);
			$("#driver_phone").html(requestDetails.driver_phone);
$( "#cancel_request" ).off();
			$( "#cancel_request" ).click(requestDetails.request_id, function (event) {
					cancel(event.data);
					console.log(event.data);
			} );


			if (isDriverOnline(requestDetails.driver_id)) {
					$("#driver_status").html("Online");
			} else {
				$("#driver_status").html("Offline");

			}
		}

		function showDriverDetails(driverDetails) {

			}

		function isDriverOnline(id){
			if (window.globals.drivers != null ) {
				for (var i = 0; i < window.globals.drivers.length; i++) {
					if (window.globals.drivers[0].id == id){
						return true;
					}
				}
			}
			return false;

		}

		function reshowRequestsMarkers(){
			if (window.globals.requestMarkers != null) {
				for (var i = 0; i < window.globals.requestMarkers.length; i++) {
					window.globals.requestMarkers[i].setMap(window.globals.map);
				}
			}
		}

		function enterRedirectMode(){
			console.log(window.globals.selectionState);
			if (window.globals.selectionState != REDIRECT) {
				hideRequestsMarkers();
				$( "#cancel_request" ).css( "display", "none" );
				$( "#redirect_request" ).html( "Cancel redirection" );
				window.globals.selectionState = REDIRECT;

			} else {
				reshowRequestsMarkers();
				$( "#cancel_request" ).css( "display", "block" );
				$( "#redirect_request" ).html( "Redirect Request" );
				window.globals.selectionState = CLEAR;
			}


		}


		function getRequestIndexById(id){

				if (window.globals.requestMarkers != null) {
					for (var i = 0; i < window.globals.requestMarkers.length; i++) {
						if (window.globals.requestMarkers[i].details.request_id == id){
							return i;

						}
					}
				}

		}

function getDriverIndexById(id){

				if (window.globals.driversMarkers != null) {
					for (var i = 0; i < window.globals.driversMarkers.length; i++) {
						if (window.globals.driversMarkers[i].details.id == id){
							return i;

						}
					}
				}

		}

		function removeRequest(id){
			index = getRequestIndexById(id);
			window.globals.requestMarkers[index].setMap(null);
			window.globals.requestMarkers.splice(index,1);

			window.globals.requests.splice(index,1);



		}



	</script>
	<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3OefEn0Ul0NJcBKU2ShzVZ8FMBGIT3qM&callback=initMap">
</script>

</body>
</html>
